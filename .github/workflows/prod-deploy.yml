name: Deploy to PROD

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version to deploy to PROD (e.g. 1.2.3)"
        required: true

permissions:
  contents: write

env:
  AWS_REGION: us-east-1
  REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
  EKS_CLUSTER_NAME: prod-cluster-name
  PROD_BASE_URL: ${{ secrets.PROD_BASE_URL }}

jobs:
  prod-pre-deploy-validation:
    name: PROD Pre-Deploy SLO/SLA Capture
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Verify BETA deployment completed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NOTES=$(gh release view v${{ inputs.version }} --json body --jq '.body')
          echo "$NOTES" | grep "BETA_DEPLOYED=true"

      - name: Capture PRE-deploy PROD SLO/SLA baseline
        run: |
          RELEASE_VERSION="v${{ inputs.version }}"
          CAPTURE_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          carpenter capture \
            --environment prod \
            --service hub-dashboard \
            --release "$RELEASE_VERSION" \
            --phase pre-deploy \
            --timestamp "$CAPTURE_TIME"


  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: prod-pre-deploy-validation
    environment: prod

    steps:
      - name: Verify BETA deployment completed (hard gate)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NOTES=$(gh release view v${{ inputs.version }} --json body --jq '.body')
          echo "$NOTES" | grep "BETA_DEPLOYED=true"

      - name: Extract image from release
        id: image
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY=$(gh release view v${{ inputs.version }} --json body --jq '.body')
          IMAGE=$(echo "$BODY" | grep -m1 "${REGISTRY_URL}")
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "Deploying image: $IMAGE"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region "$AWS_REGION" \
            --name "$EKS_CLUSTER_NAME"

      - name: Helm deploy to PROD
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          IMAGE_REPO=$(echo "$IMAGE" | cut -d: -f1)
          IMAGE_TAG=$(echo "$IMAGE" | cut -d: -f2)

          helm upgrade --install springboot ./helm \
            --namespace default \
            --create-namespace \
            --set image.repository="$IMAGE_REPO" \
            --set image.tag="$IMAGE_TAG"

  prod-post-deploy-validation:
    name: PROD Post-Deploy Validation
    runs-on: ubuntu-latest
    needs: deploy-prod

    steps:
      - name: Wait for PROD readiness
        run: |
          for i in {1..10}; do
            curl -f "$PROD_BASE_URL" && break
            sleep 10
          done

      - name: Run controlled performance tests
        run: |
          chmod +x performance/run-prod-perf-tests.sh
          ./performance/run-prod-perf-tests.sh

      - name: Capture POST-deploy PROD SLO/SLA
        run: |
          RELEASE_VERSION="v${{ inputs.version }}"
          CAPTURE_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          carpenter capture \
            --environment prod \
            --service hub-dashboard \
            --release "$RELEASE_VERSION" \
            --phase post-deploy \
            --timestamp "$CAPTURE_TIME"

      - name: Compare PRE vs POST deploy SLO/SLA
        run: |
          carpenter compare \
            --environment prod \
            --service hub-dashboard \
            --release "v${{ inputs.version }}" \
            --fail-on-regression \
            --latency-threshold 10 \
            --error-rate-threshold 0.5 \
            --availability-threshold 99.9


  notify-prod:
    name: Notify PROD Deployment
    runs-on: ubuntu-latest
    needs: prod-post-deploy-validation
    if: success()

    steps:
      - name: Mark release as PROD deployed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY=$(gh release view v${{ inputs.version }} --json body --jq '.body')

          if echo "$BODY" | grep -q "PROD_DEPLOYED=true"; then
            echo "PROD already marked."
          else
            gh release edit v${{ inputs.version }} --notes "$BODY
            PROD_DEPLOYED=true"
          fi

      - name: Send PROD notification
        run: |
          curl -X POST "${{ secrets.PROD_WEBHOOK_ID }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"PROD deployment successful  Version: v${{ inputs.version }}\"}"
