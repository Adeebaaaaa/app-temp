name: Deploy to BETA

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version to deploy (e.g. 1.2.3)"
        required: true

permissions:
  contents: write

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: beta-cluster-name
  REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
  BASE_URL: ${{ secrets.BETA_BASE_URL }}

jobs:
  deploy-beta:
    runs-on: ubuntu-latest
    environment: beta

    steps:
      - uses: actions/checkout@v4

      # ---------------- VALIDATE RELEASE EXISTS ----------------
      - name: Validate GitHub Release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release view v${{ inputs.version }} >/dev/null

      # ---------------- VERIFY DEV DEPLOYMENT COMPLETED ----------------
      - name: Verify DEV deployment completed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NOTES=$(gh release view v${{ inputs.version }} --json body --jq '.body')
          echo "$NOTES" | grep "DEV_DEPLOYED=true"

      # ---------------- EXTRACT IMAGE ----------------
      - name: Extract image from release
        id: image
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY=$(gh release view v${{ inputs.version }} --json body --jq '.body')
          IMAGE=$(echo "$BODY" | grep -m1 "${REGISTRY_URL}")
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "Deploying image: $IMAGE"

      # ---------------- AWS AUTH ----------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region "$AWS_REGION" \
            --name "$EKS_CLUSTER_NAME"

      # ---------------- HELM DEPLOY ----------------
      - name: Helm deploy to BETA
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          IMAGE_REPO=$(echo "$IMAGE" | cut -d: -f1)
          IMAGE_TAG=$(echo "$IMAGE" | cut -d: -f2)

          helm upgrade --install springboot ./helm \
            --namespace default \
            --create-namespace \
            --set image.repository="$IMAGE_REPO" \
            --set image.tag="$IMAGE_TAG"

  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: deploy-beta

    steps:
      - run: sudo apt-get update && sudo apt-get install -y curl

      - name: Wait for readiness
        run: |
          for i in {1..10}; do
            curl -f "$BASE_URL/" && break
            sleep 10
          done

      - run: curl "$BASE_URL/"

  notify-beta:
    runs-on: ubuntu-latest
    needs: post-deploy-tests
    if: success()

    steps:
      - name: Mark release as BETA deployed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY=$(gh release view v${{ inputs.version }} --json body --jq '.body')

          if echo "$BODY" | grep -q "BETA_DEPLOYED=true"; then
            echo "BETA already marked."
          else
            gh release edit v${{ inputs.version }} --notes "$BODY
            BETA_DEPLOYED=true"
          fi

      - name: Notify Google Chat
        run: |
          curl -X POST "${{ secrets.BETA_WEBHOOK_ID }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"BETA deployment successful  Version: v${{ inputs.version }}\"}"
