name: Deploy to DEV

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version to deploy (e.g. 1.2.3)"
        required: true

permissions:
  contents: read

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: dev-test-destroy
  REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
  BASE_URL: ${{ secrets.DEV_BASE_URL }}

jobs:
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    environment: dev  
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------- VALIDATE RELEASE EXISTS --------
      - name: Validate GitHub Release exists
        run: |
          gh release view v${{ inputs.version }} >/dev/null
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------- EXTRACT IMAGE FROM RELEASE --------
      - name: Extract image from release
        id: image
        run: |
          BODY=$(gh release view v${{ inputs.version }} --json body --jq '.body')

          IMAGE=$(echo "$BODY" | grep -m1 "${REGISTRY_URL}" | awk '{print $1}')
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

          echo "Deploying image: $IMAGE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------- AWS AUTH --------
      - name: Configure AWS
        run: |
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set region "$AWS_REGION"

      # -------- KUBECONFIG --------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region "$AWS_REGION" \
            --name "$EKS_CLUSTER_NAME"

      # -------- HELM DEPLOY --------
      - name: Helm deploy to DEV
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          IMAGE_REPO=$(echo "$IMAGE" | cut -d: -f1)
          IMAGE_TAG=$(echo "$IMAGE" | cut -d: -f2)

          helm upgrade --install springboot ./helm \
            --namespace default \
            --create-namespace \
            --set image.repository="$IMAGE_REPO" \
            --set image.tag="$IMAGE_TAG"

      # -------- VERIFY CLUSTER --------
      - name: Verify DEV deployment
        run: |
          kubectl get deployments -n default
          kubectl get pods -n default
          kubectl get svc -n default
          kubectl get nodes
          kubectl get events -n default --sort-by=.lastTimestamp | tail -20
      - name: Mark release as DEV deployed
        run: |
            gh release edit v${{ inputs.version }} \
            --notes "$(gh release view v${{ inputs.version }} --json body --jq '.body')
            DEV_DEPLOYED=true"
            env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-deploy-tests:
    name: Post Deploy DEV Tests
    runs-on: ubuntu-latest
    needs: deploy-dev

    steps:
      - name: Install curl
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: Wait for app readiness
        run: |
          READY=false
          for i in {1..10}; do
            if curl -fs "$BASE_URL/"; then
              READY=true
              break
            fi
            echo "App not ready yet... retrying"
            sleep 10
          done

          if [ "$READY" = false ]; then
            echo "ERROR: App did not become ready"
            exit 1
          fi

      - name: Smoke test
        run: |
          curl "$BASE_URL/"

      - name: DEV tests completed
        run: echo "DEV post-deploy tests completed"

  notify-dev:
    name: Notify DEV Deployment
    runs-on: ubuntu-latest
    needs: post-deploy-tests
    if: success()

    steps: 
      - name: Mark release as DEV deployed
        run: |
            gh release edit v${{ inputs.version }} \
            --notes "$(gh release view v${{ inputs.version }} --json body --jq '.body')
            DEV_DEPLOYED=true"
            env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Send Google Chat notification
        run: |
          curl -X POST "${{ secrets.DEV_WEBHOOK_ID }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"DEV deployment successful ðŸš€\nVersion: v${{ inputs.version }}\"
            }"
      